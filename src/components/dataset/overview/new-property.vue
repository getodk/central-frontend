<!--
Copyright 2024 ODK Central Developers
See the NOTICE file at the top-level directory of this distribution and at
https://github.com/getodk/central-frontend/blob/master/NOTICE.

This file is part of ODK Central. It is subject to the license terms in
the LICENSE file found in the top-level directory of this distribution and at
https://www.apache.org/licenses/LICENSE-2.0. No part of ODK Central,
including this file, may be copied, modified, propagated, or distributed
except according to the terms contained in the LICENSE file.
-->
<template>
  <modal id="dataset-property-new" :state="state" :hideable="!awaitingResponse" backdrop
    @hide="$emit('hide')" @shown="nameGroup.focus()">
    <template #title>{{ $t('title') }}</template>
    <template #body>
      <div class="modal-introduction">
        <p>{{ $t('introduction[0]') }}</p>
      </div>
      <form @submit.prevent="submit">
        <form-group ref="nameGroup" v-model.trim="name"
          :placeholder="$t('newPropertyName')" required autocomplete="off"/>
        <p>{{ $t('introduction[1]') }}</p>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary"
            :aria-disabled="awaitingResponse">
            {{ $t('action.create') }} <spinner :state="awaitingResponse"/>
          </button>
          <button type="button" class="btn btn-link"
            :aria-disabled="awaitingResponse" @click="$emit('hide')">
            {{ $t('action.cancel') }}
          </button>
        </div>
      </form>
    </template>
  </modal>
</template>

<script setup>
import { inject, ref, watch } from 'vue';
import { equals } from 'ramda';
import { useI18n } from 'vue-i18n';

import Modal from '../../modal.vue';
import FormGroup from '../../form-group.vue';
import Spinner from '../../spinner.vue';

import useRequest from '../../../composables/request';
import { apiPaths } from '../../../util/request';
import { useRequestData } from '../../../request-data';
import { noop } from '../../../util/util';

const { request, awaitingResponse } = useRequest();
const { project, dataset } = useRequestData();

defineOptions({
  name: 'DatasetPropertyNew'
});
const props = defineProps({
  state: {
    type: Boolean,
    default: false
  }
});
const nameGroup = ref(null);
const name = ref('');

const emit = defineEmits(['hide', 'success']);
const alert = inject('alert');

watch(() => props.state, (state) => {
  if (!state) name.value = '';
});

const { t } = useI18n();
const submit = () => {
  request({
    method: 'POST',
    url: apiPaths.datasetProperties(project.id, dataset.name),
    data: { name: name.value },
    problemToAlert: ({ code, details }) =>
      (code === 409.3 && equals(details.fields, ['name', 'datasetId'])
        ? t('problem.409_3', { propertyName: details.values[0] })
        : null)
  })
    .then(() => {
      alert.blank();
      emit('success');
    })
    .catch(noop);
};
</script>

<i18n lang="json5">
{
  "en": {
    // This is the title at the top of a pop-up.
    "title": "Add Entity Property",
    "introduction": [
      "To add an Entity property, choose a unique property name below.",
      "You can also add new properties by uploading a Form that references them, in which case the properties are created when the Form is published."
    ],
    "newPropertyName": "New property name",
    "problem": {
      "409_3": "A property already exists in this Entity List with the name of “{propertyName}”."
    },
  }
}
</i18n>

<!-- Autogenerated by destructure.js -->
<i18n>
{
  "de": {
    "title": "Entitätseigenschaft hinzufügen",
    "introduction": [
      "Um eine Entitätseigenschaft hinzuzufügen, wählen Sie unten einen eindeutigen Eigenschaftsnamen.",
      "Sie können auch neue Eigenschaften hinzufügen, indem Sie ein Formular hochladen, das auf sie verweist. In diesem Fall werden die Eigenschaften erstellt, wenn das Formular veröffentlicht wird."
    ],
    "newPropertyName": "Neuer Eigenschaftsname",
    "problem": {
      "409_3": "In dieser Entitätsliste existiert bereits eine Eigenschaft mit dem Namen “{propertyName}”."
    }
  },
  "es": {
    "title": "Añadir propiedad de entidad",
    "introduction": [
      "Para añadir una propiedad de Entidad, elija un nombre de propiedad único a continuación.",
      "También puede añadir nuevas propiedades cargando un Formulario que haga referencia a ellas, en cuyo caso las propiedades se crean cuando se publica el Formulario."
    ],
    "newPropertyName": "Nuevo nombre de propiedad",
    "problem": {
      "409_3": "Ya existe una propiedad en esta lista de entidades con el nombre “{propertyName}”."
    }
  },
  "fr": {
    "title": "Ajouter une Propriété d'Entité",
    "introduction": [
      "Pour ajouter une propriété d'Entité, choisissez un nom de propriété unique ci-dessous.",
      "Vous pouvez ajoutez de nouvelles propriétés en téléchargeant un Formulaire qui y fait référence, dans lequel les propriétés sont créées lors de la publication du Formulaire."
    ],
    "newPropertyName": "Nom de la nouvelle propriété",
    "problem": {
      "409_3": "Une propriété nommée \"{propertyName}\" existe déjà pour cette liste d'Entités."
    }
  },
  "it": {
    "title": "Aggiungi proprietà della Entità",
    "introduction": [
      "Per aggiungere una proprietà dell'entità, scegliere un nome univoco per la proprietà qui sotto.",
      "È possibile aggiungere nuove proprietà anche caricando un formulario che vi fa riferimento; in questo caso, le proprietà vengono create quando il formulario viene pubblicato."
    ],
    "newPropertyName": "Nuovo nome della proprietà",
    "problem": {
      "409_3": "Esiste già una proprietà in questo elenco di entità con il nome \"{propertyName}”."
    }
  },
  "zh-Hant": {
    "title": "新增實體屬性",
    "introduction": [
      "若要新增實體屬性，請在下方選個唯一屬性名稱。",
      "您也可以透過上傳引用新屬性的表單來新增屬性，在這種情況下，屬性會在發布表單時建立。"
    ],
    "newPropertyName": "新屬性名稱",
    "problem": {
      "409_3": "此實體清單中已存在名稱為「{propertyName}」的屬性。"
    }
  }
}
</i18n>
