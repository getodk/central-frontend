<!--
Copyright 2023 ODK Central Developers
See the NOTICE file at the top-level directory of this distribution and at
https://github.com/getodk/central-frontend/blob/master/NOTICE.

This file is part of ODK Central. It is subject to the license terms in
the LICENSE file found in the top-level directory of this distribution and at
https://www.apache.org/licenses/LICENSE-2.0. No part of ODK Central,
including this file, may be copied, modified, propagated, or distributed
except according to the terms contained in the LICENSE file.
-->

<template>
  <div id="connection-to-forms">
    <div id="connection-to-forms-heading">{{ $tcn('formsUpdateEntities', propertiesByForm.length) }}</div>
    <div class="div">
      <expandable-row v-for="form in propertiesByForm" :key="form.xmlFormId">
        <template #title>
          <div class="form-name-and-tags">
            <span class="form-name">
              <form-link :form="form"
                :to="publishedFormPath(form.projectId, form.xmlFormId)"
                v-tooltip.text/>
            </span>
            <span v-if="form.repeatPath" class="repeat-tag"
              v-tooltip.no-aria="form.repeatPath">
              <span class="icon-refresh"></span>
              <span class="repeat-path">
                <!-- Path includes leading and trailing slashes e.g. /plot/tree/ -->
                {{ form.repeatPath.slice(0, -1).split('/').pop() }}
              </span>
            </span>
          </div>
        </template>
        <template #caption>
          {{ $tcn('common.propertiesCount', totalProperties, { inform: $n(form.properties.length, 'default') }) }}
        </template>
        <template #details>
          <i18n-list :list="form.properties" class="property-list"/>
          <span v-if="form.properties.length === 0" class="no-properties">{{ $t('entity.noProperties') }}</span>
        </template>
      </expandable-row>
    </div>
  </div>
</template>

<script>
import ExpandableRow from '../../expandable-row.vue';
import FormLink from '../../form/link.vue';
import I18nList from '../../i18n/list.vue';

import useRoutes from '../../../composables/routes';
import { useRequestData } from '../../../request-data';

export default {
  name: 'ConnectionToForms',
  components: {
    ExpandableRow,
    FormLink,
    I18nList
  },
  setup() {
    const { dataset } = useRequestData();
    const { publishedFormPath } = useRoutes();
    return { dataset, publishedFormPath };
  },
  computed: {
    totalProperties() {
      return this.dataset.properties.length;
    },
    propertiesByForm() {
      const formMap = new Map(this.dataset.sourceForms.map(f =>
        [f.xmlFormId, { ...f, properties: [] }]));

      for (const p of this.dataset.properties) {
        for (const f of p.forms) {
          const form = formMap.get(f.xmlFormId);
          form.properties.push(p.name);
        }
      }

      return Array.from(formMap.values());
    }
  }
};
</script>

<style lang="scss">
@import '../../../assets/scss/mixins';

#connection-to-forms{
  margin-bottom: 10px;

  #connection-to-forms-heading {
    margin: 10px 0px;
    font-weight: 700;
  }

  .expandable-row {
    border-bottom: 1px solid #ddd;
  }

  .expandable-row:last-child {
    border-bottom: none;
  }

  .expandable-row-title {
    max-width: calc(100% - 180px);

    .form-name-and-tags {
      display: flex;
    }

    .form-name{
      @include text-overflow-ellipsis;

      // Shrink name to fit so there is room for tag right next to it
      flex-shrink: .5;
    }

    .repeat-tag {
      @include text-overflow-ellipsis;

      // CSS
      border-radius: 100px;
      background: #D0E7F1;
      font-size: 12px;

      // Layout
      display: inline-flex;
      height: 24px;
      min-width: 42px;
      margin-left: 8px;
      padding: 4px 8px;
      justify-content: center;
      align-items: center;
      gap: 4px;

      // Shrink tag
      flex-shrink: 1;

      .icon-refresh{
        flex-shrink: 0;
      };

      .repeat-path {
         @include text-overflow-ellipsis;
      }
    }
  }

  a, .expandable-row-toggle-button {
    font-size: 16px;
  }

  .property-list {
    hyphens: auto;
    overflow-wrap: break-word;
  }

  .no-properties { @include italic; }
}
</style>

<i18n lang="json5">
{
  "en": {
    "formsUpdateEntities": "{count} Form updating Entities | {count} Forms updating Entities"
  }
}
</i18n>

<!-- Autogenerated by destructure.js -->
<i18n>
{
  "de": {
    "formsUpdateEntities": "{count} Formular, die Entitäten aktualisieren. | {count} Formulare, die Entitäten aktualisieren."
  },
  "es": {
    "formsUpdateEntities": "{count} Formulario que actualiza entidades. | {count} Formularios que actualizan entidades. | {count} Formularios que actualizan entidades."
  },
  "fr": {
    "formsUpdateEntities": "{count} formulaire met à jour des Entités. | {count} formulaires mettent à jour des Entités. | {count} formulaires mettent à jour des Entités."
  },
  "it": {
    "formsUpdateEntities": "{count} Formulario che aggiorna Entità | {count} Formulari che aggiornano Entità | {count} Formulari che aggiornano Entità"
  },
  "pt": {
    "formsUpdateEntities": "{count} Formulário atualizando Entidades | {count} Formulários atualizando Entidades | {count} Formulários atualizando Entidades"
  },
  "zh": {
    "formsUpdateEntities": "{count}个表单正在更新实体"
  },
  "zh-Hant": {
    "formsUpdateEntities": "{count}個表單正在更新實體"
  }
}
</i18n>
