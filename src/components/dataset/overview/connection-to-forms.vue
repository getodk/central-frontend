<!--
Copyright 2023 ODK Central Developers
See the NOTICE file at the top-level directory of this distribution and at
https://github.com/getodk/central-frontend/blob/master/NOTICE.

This file is part of ODK Central. It is subject to the license terms in
the LICENSE file found in the top-level directory of this distribution and at
https://www.apache.org/licenses/LICENSE-2.0. No part of ODK Central,
including this file, may be copied, modified, propagated, or distributed
except according to the terms contained in the LICENSE file.
-->

<template>
  <summary-item id="connection-to-forms" icon="magic-wand">
    <template #heading>
      {{ propertiesByForm.length }}
    </template>
    <template #body>
      <p>{{ $tcn('formsUpdateEntities', propertiesByForm.length) }}</p>
      <div class="div">
        <expandable-row v-for="(form) in propertiesByForm" :key="form.xmlFormId">
          <template #title>
            <div class="form-name">
              <form-link :form="form"
                :to="publishedFormPath(form.projectId, form.xmlFormId)"
                v-tooltip.text/>
            </div>
          </template>
          <template #caption>
            {{ $tcn('common.propertiesCount', totalProperties, { inform: $n(form.properties.length, 'default') }) }}
          </template>
          <template #details>
            <i18n-list :list="form.properties" class="property-list"/>
            <span v-if="form.properties.length === 0" class="no-properties">{{ $t('entity.noProperties') }}</span>
          </template>
        </expandable-row>
      </div>
    </template>
  </summary-item>
</template>

<script>
import ExpandableRow from '../../expandable-row.vue';
import FormLink from '../../form/link.vue';
import I18nList from '../../i18n/list.vue';
import SummaryItem from '../../summary-item.vue';

import useRoutes from '../../../composables/routes';
import { useRequestData } from '../../../request-data';

export default {
  name: 'ConnectionToForms',
  components: {
    ExpandableRow,
    FormLink,
    I18nList,
    SummaryItem
  },
  setup() {
    const { dataset } = useRequestData();
    const { publishedFormPath } = useRoutes();
    return { dataset, publishedFormPath };
  },
  computed: {
    totalProperties() {
      return this.dataset.properties.length;
    },
    propertiesByForm() {
      const formMap = new Map(this.dataset.sourceForms.map(f =>
        [f.xmlFormId, { ...f, properties: [] }]));

      for (const p of this.dataset.properties) {
        for (const f of p.forms) {
          const form = formMap.get(f.xmlFormId);
          form.properties.push(p.name);
        }
      }

      return Array.from(formMap.values());
    }
  }
};
</script>

<style lang="scss">
@import '../../../assets/scss/mixins';

#connection-to-forms{
  margin-bottom: 10px;

  .expandable-row {
    border-bottom: 1px solid #ddd;
  }

  .expandable-row:last-child {
    border-bottom: none;
  }

  .title-cell{
    max-width: calc(100% - 180px);

    .form-name {
      @include text-overflow-ellipsis;
    }
  }

  a, .expandable-row button {
    font-size: 16px;
  }

  .property-list {
    hyphens: auto;
    overflow-wrap: break-word;
  }

  .no-properties { @include italic; }
}
</style>

<i18n lang="json5">
{
  "en": {
    // The number of Form(s) is shown separately above this text.
    "formsUpdateEntities": "Form updates Entities in this Entity List | Forms update Entities in this Entity List"
  }
}
</i18n>

<!-- Autogenerated by destructure.js -->
<i18n>
{
  "de": {
    "formsUpdateEntities": "Formular aktualisiert Objekte in dieser Objektliste | Formulare aktualisieren Objekte in dieser Objektliste"
  },
  "es": {
    "formsUpdateEntities": "El formulario actualiza Entidades en esta Lista de Entidades | Los formularios actualizan Entidades en esta Lista de Entidades | Los formularios actualizan Entidades en esta Lista de Entidades"
  },
  "fr": {
    "formsUpdateEntities": "Formulaire modifiant des Entités de cette Liste d'Entités | Formulaires modifiant des Entités de cette Liste d'Entités | Formulaires modifiant des Entités de cette Liste d'Entités"
  },
  "it": {
    "formsUpdateEntities": "Formulario aggiorna Entità in questa lista di Entità | Formulari aggiornano Entità in questa lista di Entità | Formulari aggiornano Entità in questa lista di Entità"
  },
  "zh-Hant": {
    "formsUpdateEntities": "表單更新此實體清單中的實體"
  }
}
</i18n>
