<!--
Copyright 2025 ODK Central Developers
See the NOTICE file at the top-level directory of this distribution and at
https://github.com/getodk/central-frontend/blob/master/NOTICE.

This file is part of ODK Central. It is subject to the license terms in
the LICENSE file found in the top-level directory of this distribution and at
https://www.apache.org/licenses/LICENSE-2.0. No part of ODK Central,
including this file, may be copied, modified, propagated, or distributed
except according to the terms contained in the LICENSE file.
-->
<template>
  <div class="panel panel-simple">
    <div class="panel-heading">
      <h1 class="panel-title">{{ $t('panel.title') }}</h1>
    </div>
    <div class="panel-body">
      <form @change="confirmationModal.show()" @submit.prevent>
        <div class="radio">
          <label>
            <input v-model="ownerOnly" type="radio" :value="false"
              aria-describedby="dataset-owner-only-false-help"
              :disabled="awaitingResponse">
            <strong>{{ $t('accessAllDefault') }}</strong>
          </label>
          <p id="dataset-owner-only-false-help" class="help-block">
            {{ $t('radio.false') }}
          </p>
        </div>
        <div class="radio">
          <label>
            <input v-model="ownerOnly" type="radio" :value="true"
              aria-describedby="dataset-owner-only-true-help"
              :disabled="awaitingResponse">
            <strong>{{ $t('ownerOnly') }}</strong>
          </label>
          <p id="dataset-owner-only-true-help" class="help-block">
            {{ $t('radio.true') }}
          </p>
        </div>
      </form>
    </div>
  </div>
  <modal v-bind="confirmationModal" :hideable="!awaitingResponse" backdrop
    @hide="cancel">
    <template #title>{{ ownerOnly ? $t('ownerOnly') : $t('accessAll') }}</template>
    <template #body>
      <p class="modal-introduction">
        {{ ownerOnly ? $t('trueModal.introduction') : $t('falseModal.introduction') }}
      </p>
      <div class="modal-actions">
        <button type="button" class="btn btn-link"
          :aria-disabled="awaitingResponse" @click="cancel">
          {{ $t('action.cancel') }}
        </button>
        <button type="button" class="btn btn-primary"
          :aria-disabled="awaitingResponse" @click="confirm">
          {{ ownerOnly ? $t('trueModal.action.confirm') : $t('accessAll') }}
          <spinner :state="awaitingResponse"/>
        </button>
      </div>
    </template>
  </modal>
</template>

<script setup>
import { inject, ref, watch } from 'vue';
import { useI18n } from 'vue-i18n';

import Modal from '../modal.vue';
import Spinner from '../spinner.vue';

import useRequest from '../../composables/request';
import { apiPaths } from '../../util/request';
import { modalData } from '../../util/reactivity';
import { noop } from '../../util/util';
import { useRequestData } from '../../request-data';

defineOptions({
  name: 'DatasetOwnerOnly'
});

const { t } = useI18n();
const { alert } = inject('container');

// The component assumes that this data will exist when the component is
// created.
const { dataset } = useRequestData();

const ownerOnly = ref(false);
watch(
  () => dataset.dataExists,
  (dataExists) => { if (dataExists) ownerOnly.value = dataset.ownerOnly; },
  { immediate: true }
);

const confirmationModal = modalData();
const cancel = () => {
  confirmationModal.hide();
  ownerOnly.value = !ownerOnly.value;
};

const { request, awaitingResponse } = useRequest();
const update = async (value) => {
  const { data } = await request({
    method: 'PATCH',
    url: apiPaths.dataset(dataset.projectId, dataset.name),
    data: { ownerOnly: value }
  });
  dataset.ownerOnly = data.ownerOnly;
};
const undo = () => update(!ownerOnly.value)
  .then(() => {
    ownerOnly.value = !ownerOnly.value;
    return true;
  })
  .catch(noop);
const confirm = () => update(ownerOnly.value)
  .then(() => {
    confirmationModal.hide();
    const message = dataset.ownerOnly
      ? t('alert.changeToTrue')
      : t('alert.changeToFalse');
    alert.success(message).cta(t('action.undo'), undo);
  })
  .catch(noop);
</script>

<i18n lang="json5">
{
  "en": {
    "panel": {
      // This is a title shown above a section of the page.
      "title": "App User and Data Collector Entity Access"
    },
    "accessAll": "Access all Entities",
    "accessAllDefault": "Access all Entities (default)",
    "ownerOnly": "Only access own Entities",
    "radio": {
      "false": "App Users and Data Collectors within this Project will have access to all Entities within their assigned Forms.",
      "true": "App Users and Data Collectors within this Project will only have access to the Entities they create, promoting privacy and limiting data transfers."
    },
    "falseModal": {
      "introduction": "App Users and Data Collectors will have access to all Entities, including ones they did not create."
    },
    "trueModal": {
      "introduction": "App Users and Data Collectors will lose access to the Entities they have not created. All other user types keep access to all Entities.",
      "action": {
        "confirm": "Access own Entities"
      }
    },
    "alert": {
      "changeToFalse": "App Users and Data Collectors will now have access to all Entities.",
      "changeToTrue": "App Users and Data Collectors will now only have access to Entities they create."
    }
  }
}
</i18n>

<!-- Autogenerated by destructure.js -->
<i18n>
{
  "es": {
    "panel": {
      "title": "Acceso a la entidad del Usuario de la aplicación y recopilador de datos"
    },
    "accessAll": "Acceder a todas las entidades",
    "accessAllDefault": "Acceder a todas las Entidades (por defecto)"
  },
  "fr": {
    "panel": {
      "title": "Accès d'entités pour les utilisateurs mobiles et les collecteurs de données web"
    },
    "accessAll": "Accès à toutes les entités",
    "accessAllDefault": "Accès à toutes les entités (défaut)",
    "ownerOnly": "Accès uniquement à ses propres entités",
    "radio": {
      "false": "Les utilisateurs mobiles et les collecteurs de données web de ce projet auront accès à toutes les entités à partir des formulaires qu'ils leur sont assignés.",
      "true": "Les utilisateurs mobiles et les collecteurs de données web de ce projet n'auront accès qu'aux entités qu'ils ont créées. Ceci encourage la confidentialité et limite les transferts de données."
    },
    "falseModal": {
      "introduction": "Les utilisateurs mobiles et le collecteurs de données web auront accès à toutes les entités, incluant celles créées par d'autres utilisateurs."
    },
    "trueModal": {
      "introduction": "Les utilisateurs mobiles et les collecteurs de données web perdront accès aux entités crées par d'autres utilisateurs. Tous les autres utilisateurs garderont accès à toutes les entités.",
      "action": {
        "confirm": "Accéder propres entités"
      }
    },
    "alert": {
      "changeToFalse": "Les utilisateurs mobiles et les collecteurs de données web auront maintenant accès à toutes les entités.",
      "changeToTrue": "Les utilisateurs mobiles et les collecteurs de données web auront maintenant accès seulement aux entités qu'ils ont créées."
    }
  },
  "it": {
    "panel": {
      "title": "Accesso dell'utente dell'app e del raccoglitore di dati alla Entità"
    },
    "accessAll": "Accedi a tutte le entità",
    "accessAllDefault": "Accedi a tutte le entità (predefinito)",
    "ownerOnly": "Accedere solo alle proprie entità",
    "radio": {
      "false": "Gli utenti delle app e i raccoglitori di dati nell'ambito di questo progetto avranno accesso a tutte le entità all'interno dei moduli loro assegnati.",
      "true": "Gli utenti dell'app e i raccoglitori di dati nell'ambito di questo progetto avranno accesso solo alle entità da loro create, promuovendo la privacy e limitando i trasferimenti di dati."
    },
    "falseModal": {
      "introduction": "Gli utenti dell'app e i raccoglitori di dati avranno accesso a tutte le entità, comprese quelle che non hanno creato."
    },
    "trueModal": {
      "introduction": "Gli utenti delle app e i raccoglitori di dati perderanno l'accesso alle entità che non hanno creato. Tutti gli altri tipi di utenti mantengono l'accesso a tutte le Entità.",
      "action": {
        "confirm": "Accedere alle proprie entità"
      }
    },
    "alert": {
      "changeToFalse": "Gli utenti dell'app e i raccoglitori di dati avranno ora accesso a tutte le entità.",
      "changeToTrue": "Gli utenti delle app e i raccoglitori di dati avranno ora accesso solo alle entità da loro create."
    }
  },
  "zh-Hant": {
    "panel": {
      "title": "應用程式使用者和資料收集器實體存取"
    },
    "accessAll": "存取所有實體",
    "accessAllDefault": "存取所有實體 (預設)",
    "ownerOnly": "僅存取自己的實體",
    "radio": {
      "false": "此專案中的 App 使用者和資料收集者將可存取其指定表單中的所有實體。",
      "true": "此專案中的 App 使用者和資料收集者僅能存取他們所建立的實體，以促進隱私權並限製資料傳輸。"
    },
    "falseModal": {
      "introduction": "App 使用者和資料收集者將可存取所有實體，包括他們未建立的實體。"
    },
    "trueModal": {
      "introduction": "App 使用者和資料收集者將失去對他們未建立的實體的存取權。所有其他使用者類型則保留對所有實體的存取權。",
      "action": {
        "confirm": "存取自己的實體"
      }
    },
    "alert": {
      "changeToFalse": "App 使用者和資料收集者現在可以存取所有實體。",
      "changeToTrue": "App 使用者和資料收集者現在只能存取他們所建立的實體。"
    }
  }
}
</i18n>
