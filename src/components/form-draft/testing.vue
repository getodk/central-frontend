<!--
Copyright 2020 ODK Central Developers
See the NOTICE file at the top-level directory of this distribution and at
https://github.com/getodk/central-frontend/blob/master/NOTICE.

This file is part of ODK Central. It is subject to the license terms in
the LICENSE file found in the top-level directory of this distribution and at
https://www.apache.org/licenses/LICENSE-2.0. No part of ODK Central,
including this file, may be copied, modified, propagated, or distributed
except according to the terms contained in the LICENSE file.
-->
<template>
  <form-edit-section icon="eye">
    <template #title>{{ $t('title') }}</template>
    <template #body>
      <i18n-t tag="p" keypath="deletionWarning.full">
        <template #willBeDeleted>
          <strong>{{ $t('deletionWarning.willBeDeleted') }}</strong>
        </template>
      </i18n-t>
      <div v-if="formDraft.entityRelated" id="form-draft-testing-entities">
        <span class="icon-info-circle"></span>
        <div>
          <span>{{ $t('entitiesTesting') }}</span>
          <sentence-separator/>
          <i18n-t keypath="moreInfo.helpArticle.full">
            <template #helpArticle>
              <doc-link to="central-entities/#testing-forms-with-entities">{{ $t('moreInfo.helpArticle.helpArticle') }}</doc-link>
            </template>
          </i18n-t>
        </div>
      </div>

      <loading :state="keys.initiallyLoading"/>
      <submission-list v-show="keys.dataExists" :project-id="projectId"
        :xml-form-id="xmlFormId" draft @fetch-keys="fetchKeys"
        @toggle-qr="togglePopover"/>

      <popover :target="popoverData.target" placement="right" @hide="hidePopover">
        <form-draft-qr-panel/>
      </popover>
    </template>
  </form-edit-section>
</template>

<script setup>
import { inject, shallowReactive } from 'vue';

import DocLink from '../doc-link.vue';
import FormDraftQrPanel from './qr-panel.vue';
import FormEditSection from '../form/edit/section.vue';
import Loading from '../loading.vue';
import Popover from '../popover.vue';
import SentenceSeparator from '../sentence-separator.vue';
import SubmissionList from '../submission/list.vue';

import useSubmissions from '../../request-data/submissions';
import { apiPaths } from '../../util/request';
import { noop } from '../../util/util';
import { useRequestData } from '../../request-data';

defineOptions({
  name: 'FormDraftTesting'
});
const projectId = inject('projectId');
const xmlFormId = inject('xmlFormId');

const { resourceView, createResource } = useRequestData();
const formDraft = resourceView('formDraft', (data) => data.get());
// SubmissionList expects submission stores to be created!
useSubmissions();

const keys = createResource('keys');
const fetchKeys = () => {
  // We do not reconcile `keys` and formDraft.keyId.
  keys.request({ url: apiPaths.submissionKeys(projectId, xmlFormId, true) })
    .catch(noop);
};
fetchKeys();

const popoverData = shallowReactive({ target: null });
const togglePopover = (button) => {
  popoverData.target = popoverData.target == null ? button : null;
};
const hidePopover = () => { popoverData.target = null; };
</script>

<style lang="scss">
@import '../../assets/scss/variables';

#form-draft-testing-entities {
  background-color: $color-page-background;
  color: #666;
  column-gap: $margin-right-icon;
  display: flex;
  margin-bottom: 15px;
  padding: 12px;

  .icon-info-circle {
    color: #999;
    font-size: 20px;
  }
}
</style>

<i18n lang="json5">
{
  "en": {
    // This is a title shown above a section of the page.
    "title": "Test this Draft",
    // @transifexKey component.FormDraftTesting.subtitle
    "deletionWarning": {
      "full": "Submissions made here {willBeDeleted} when you publish this Draft!",
      "willBeDeleted": "will be deleted"
    },
    "entitiesTesting": "This Form Definition creates or updates Entities. For now, Entities are not created or updated by Draft Forms, so you will need to publish the Form to verify Entity functionality."
  }
}
</i18n>

<!-- Autogenerated by destructure.js -->
<i18n>
{
  "de": {
    "title": "Diesen Entwurf prüfen",
    "entitiesTesting": "Diese Formulardefinition erstellt oder aktualisiert Objekte. Im Moment werden Objekte nicht durch Formularentwürfe erstellt oder aktualisiert, daher müssen Sie das Formular veröffentlichen, um die Funktionalität von Objekte zu überprüfen.",
    "deletionWarning": {
      "full": "Hier eingereichte Übermittlungen {willBeDeleted} wenn Sie den Entwurf veröffentlichen!",
      "willBeDeleted": "wird gelöscht"
    }
  },
  "es": {
    "title": "Probar este borrador",
    "entitiesTesting": "Esta definición de formulario crea o actualiza entidades. Por ahora, las Entidades no son creadas o actualizadas por Borradores de Formularios, por lo que necesitará publicar el Formulario para verificar la funcionalidad de la Entidad.",
    "deletionWarning": {
      "full": "Envíos realizados aquí {willBeDeleted} cuando publique este borrador.",
      "willBeDeleted": "se eliminará"
    }
  },
  "fr": {
    "title": "Tester cette ébauche",
    "entitiesTesting": "Cette définition de Formulaire crée ou met à jour des Entités. Pour le moment, les Entités ne sont pas créées ou mises à jour par les Ébauches de Formulaires, vous devez donc publier le formulaire pour vérifier le fonctionnement des Entités.",
    "deletionWarning": {
      "full": "Les soumissions créées ici {willBeDeleted} quand vous publierez le formulaire",
      "willBeDeleted": "sera supprimé"
    }
  },
  "it": {
    "title": "Testa questa Bozza",
    "entitiesTesting": "Questa Definizione di formulario crea o aggiorna le Entità. Per il momento, le entità non vengono create o aggiornate dalle bozze di formulario, quindi è necessario pubblicare il formulario per verificare la funzionalità dell'entità.",
    "deletionWarning": {
      "full": "Invii effettuati qui {willBeDeleted} quando pubblicherete questa bozza!",
      "willBeDeleted": "verrà cancellato"
    }
  },
  "pt": {
    "title": "Testar esse Rascunho",
    "deletionWarning": {
      "full": "Respostas enviadas aqui {willBeDeleted} quando você publicar esse Rascunho!",
      "willBeDeleted": "serão excluídas"
    }
  },
  "zh": {
    "title": "测试此草稿",
    "entitiesTesting": "此表单定义将创建或更新实体。目前草稿表单暂不支持实体创建或更新功能，您需要发布表单后才能验证实体功能。",
    "deletionWarning": {
      "full": "在此提交的数据在发布草稿时{willBeDeleted}！",
      "willBeDeleted": "将被删除"
    }
  },
  "zh-Hant": {
    "title": "測試此草稿",
    "entitiesTesting": "此表格定義會建立或更新實體。目前，實體不會由草稿表單建立或更新，因此您需要發佈表單以驗證實體功能。",
    "deletionWarning": {
      "full": "當您發布本草稿時，在此{willBeDeleted}提交！",
      "willBeDeleted": "將會刪除"
    }
  }
}
</i18n>
